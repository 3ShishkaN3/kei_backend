# Kei Backend — Сердце платформы Keisenpai

Бэкенд Keisenpai — это мощное приложение на Django, построенное по принципу **модульного монолита**. Оно объединяет в себе управление пользователями, курсами, контентом, прогрессом и сложную систему достижений.

## Архитектура бэкенда

Проект разработан с учетом масштабируемости и слабой связанности компонентов.

### Модульный монолит
Каждый сервис является отдельным Django-приложением. Это позволяет:
*   Изолировать логику домена.
*   Упростить тестирование.
*   В будущем легко вынести любой сервис в отдельный микросервис.

### Событийно-ориентированная модель (Kafka)
Взаимодействие между сервисами происходит асинхронно через **Apache Kafka**.
*   **Производители**: Приложения отправляют данные о событиях (например, `lesson_completed`) в Kafka.
*   **Потребители**: Специальные Django-команды прослушивают топики и обновляют прогресс, выдают достижения или уведомляют пользователя.
*   **Топики**: Основные топики — `progress_events`, `achievement_events`, `notifications`.

### Асинхронные задачи (Celery)
Для задач, которые не связаны напрямую с потоком событий, используется Celery:
*   Отправка Email.
*   Проверка тестов с помощью LLM (Gemini).
*   Периодические задачи по расписанию (Celery Beat).

---

## Состав сервисов (Apps)

1.  **`auth_service`**: Управление пользователями, ролями (Админ, Учитель, Помощник, Студент), регистрация и аутентификация.
2.  **`user_service`**: Профили пользователей, настройки и аватары.
3.  **`course_service`**: Управление каталогом курсов и записью студентов.
4.  **`lesson_service`**: Организация уроков, разделов и структуры контента.
5.  **`material_service`**: Хранилище учебных материалов (текст, видео, документы) и тестов: MCQ, d&d, тесты на порядок слов, тесты с развёрнутым ответом, кайва с сенсеем.
6.  **`dict_service`**: Словарная система, карточки слов и аудио-произношения.
7.  **`progress_service`**: Отслеживание успеваемости пользователя на разных уровнях.
8.  **`achievement_service`**: Система графов и правил для автоматической выдачи достижений.
9.  **`bonus_service`**: Система поощрений и бонусов.
10. **`notification_service`**: Центр уведомлений (WebPush, In-app).
11. **`telegram_service`**: Интеграция с ботом для учителей и уведомлений.
12. **`calendar_service`**: Календарь обучения и напоминания.

---

## Основные команды

Все команды рекомендуется запускать через `Makefile` в корне проекта или в `kei_infrastructure`. Здесь приведены прямые аналоги для понимания:

*   **Миграции**:
    ```bash
    python manage.py makemigrations
    python manage.py migrate
    ```
*   **Запуск потребителей Kafka (каждый в своем процессе)**:
    ```bash
    python manage.py consume_progress_events
    python manage.py consume_achievement_events
    ```
*   **Celery**:
    ```bash
    celery -A kei_backend worker -l info
    celery -A kei_backend beat -l info
    ```

---

## Важные компоненты

*   **Интеграция с ИИ**: Модуль оценки использует Google Gemini для проверки заданий со свободным ответом (`free-text` тесты).
*   **Утилиты Kafka**: Централизованная функция `send_to_kafka` в `kei_backend/utils.py`.
*   **API**: Документация доступна через Swagger по адресу `/swagger/`. Версионирование API: `api/v1/`.

## Структура проекта

*   `kei_backend/` — Настройки проекта, настройки Kafka, Celery и общие утилиты.
*   `management/` — Общие команды управления.
*   `scripts/` — Набор вспомогательных скриптов для миграции и обслуживания.
*   `media/` — Локальное хранилище медиа-файлов (если не используется S3).
